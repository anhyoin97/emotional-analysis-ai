<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>감정 분석 플랫폼</title>
    <style>
      body {
        margin: 0;
        font-family: "맑은 고딕", sans-serif;
        background-color: #f3f4f6;
        color: #333;
      }

      header {
        background-color: #0078d7;
        color: white;
        padding: 20px 40px;
        font-size: 1.5em;
        font-weight: bold;
        text-align: center;
      }

      main {
        display: block;
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
      }

      section {
        background-color: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 40px;
      }

      textarea {
        width: 100%;
        height: 140px;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 12px;
        font-size: 1em;
        resize: none;
      }

      button {
        margin-top: 16px;
        padding: 12px 24px;
        background-color: #0078d7;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
      }

      button:hover {
        background-color: #005ea6;
      }

      .button-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 10px;
      }

      .button-left,
      .button-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #start-record {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        padding: 0;
      }

      #stop-record {
        width: 48px;
        height: 48px;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #0078d7;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.2em;
      }

      .result-box {
        padding: 20px;
        border-left: 6px solid #0078d7;
        border-radius: 8px;
        background-color: #fefefe;
        transition: border-color 0.3s;
      }

      .result-item {
        margin-bottom: 12px;
        font-size: 1.05em;
      }

      .result-label {
        font-weight: bold;
      }

      .encouragement {
        margin-top: 20px;
        background-color: #f0f8ff;
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid #00aaff;
        font-style: italic;
      }

      .score-guide {
        margin-top: 20px;
        font-size: 0.9em;
        color: #666;
        line-height: 1.4;
        background: #f7f7f7;
        padding: 10px 14px;
        border-radius: 8px;
      }

      footer {
        text-align: center;
        padding: 24px;
        font-size: 0.9em;
        color: #888;
        border-top: 1px solid #ddd;
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <header>📝 감정 분석 플랫폼</header>

    <main>
      <section>
        <h2>오늘의 감정일기 작성</h2>
        <form id="diary-form">
          <textarea
            id="diary"
            name="diary"
            placeholder="오늘 하루를 솔직하게 적어보세요..."
          ></textarea>

          <div class="button-row">
            <div class="button-left">
              <button type="button" id="start-record" title="말하기 시작">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="white"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 14c1.66 0 3-1.34 3-3V5a3 3 0 10-6 0v6c0 1.66 1.34 3 3 3z"
                  />
                  <path
                    d="M17.3 11c0 3.07-2.4 5.6-5.3 5.98V19h3v2H9v-2h3v-2.02A6.01 6.01 0 016.7 11H5a7 7 0 0014 0h-1.7z"
                  />
                </svg>
              </button>

              <!-- 이 부분 새로 구성 -->
              <div style="display: flex; align-items: center; gap: 6px">
                <button type="button" id="stop-record" style="display: none">
                  ⛔
                </button>
                <span id="recording-status" style="color: #0078d7"></span>
              </div>
            </div>

            <div class="button-right">
              <button type="submit" id="analyze-button">분석하기</button>
            </div>
          </div>
        </form>
      </section>

      <section>
        <h2>분석 결과</h2>
        <div id="result">
          <p style="color: #888">
            일기를 작성하면 분석 결과가 여기에 표시됩니다.
          </p>
        </div>
      </section>
    </main>

    <footer>© HYOIN AN | 2025 감정분석 플랫폼</footer>

    <script>
      const emotionIcons = {
        우울: "😢",
        불안: "😟",
        분노: "😠",
        기쁨: "😄",
        슬픔: "😭",
        안정: "😊",
        피로: "😩",
        무기력: "😞",
        절망: "😔",
        희망: "🌈",
      };

      const resultDiv = document.getElementById("result");
      const form = document.getElementById("diary-form");
      
      const analyzeButton = document.querySelector('#analyze-button');

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 로딩 표시
        resultDiv.innerHTML = `<p style="color: #0078D7;">🧠 감정 분석 중입니다...</p>`;
        analyzeButton.disabled = true;
        analyzeButton.textContent = "분석 중...";

        const formData = new FormData(e.target);
        const res = await fetch("/analyze", {
          method: "POST",
          body: formData,
        });

        analyzeButton.disabled = false;
        analyzeButton.textContent = "분석하기";

        const data = await res.json();

        if (data.error) {
          resultDiv.innerHTML = `<p style="color:red;">⚠️ 분석 실패: ${
            data.raw || data.detail
          }</p>`;
          return;
        }

        const color =
          data.score >= 81
            ? "#d9534f"
            : data.score >= 61
            ? "#f0ad4e"
            : data.score >= 31
            ? "#f9e79f"
            : "#5cb85c";
        const icon = emotionIcons[data.emotion] || "🧠";

        resultDiv.innerHTML = `
      <div class="result-box" style="border-color: ${color};">
        <div class="result-item"><span class="result-label">감정:</span> ${icon} ${
          data.emotion
        }</div>
        <div class="result-item"><span class="result-label">점수:</span> ${
          data.score
        }점</div>
        <div class="result-item"><span class="result-label">이유:</span> ${
          data.reason
        }</div>
        <div class="result-item"><span class="result-label">응원의 한마디:</span> ${
          data.message
        }</div>
        <div class="encouragement">💬 오늘의 위로: “${
          data.comfort || "오늘도 잘 버텼어요. 수고했어요 :)"
        }”</div>
        <div class="score-guide">
          <strong>점수 해석 안내:</strong><br>
          ✅ 0~30: 감정 안정 상태<br>
          ⚠️ 31~60: 가벼운 감정 변화<br>
          ❗ 61~80: 부정 감정 강함<br>
          🔥 81~100: 감정적으로 매우 힘든 상태
        </div>
      </div>
    `;
      });

      const startBtn = document.getElementById("start-record");
      const stopBtn = document.getElementById("stop-record");
      const statusText = document.getElementById("recording-status");
      const diary = document.getElementById("diary");
      let recognition = null;

      function setupRecognition() {
        const recog = new webkitSpeechRecognition();
        recog.lang = "ko-KR";
        recog.interimResults = false;
        recog.maxAlternatives = 1;

        recog.onstart = () => {
          statusText.textContent = "🎙️ 듣고 있어요...";
          startBtn.style.display = "none";
          stopBtn.style.display = "inline-block";
        };

        recog.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          diary.value += (diary.value ? " " : "") + transcript;
        };

        recog.onerror = (event) => {
          statusText.textContent = "⚠️ 오류: " + event.error;
        };

        recog.onend = () => {
          statusText.textContent = "";
          startBtn.style.display = "inline-block";
          stopBtn.style.display = "none";
        };

        return recog;
      }

      startBtn.addEventListener("click", () => {
        recognition = setupRecognition();
        recognition.start();
      });

      stopBtn.addEventListener("click", () => {
        if (recognition) {
          recognition.stop();
          recognition = null;
        }
      });
    </script>
  </body>
</html>
