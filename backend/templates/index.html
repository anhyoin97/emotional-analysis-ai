<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê°ì • ë¶„ì„ í”Œë«í¼</title>
    <style>
      body {
        margin: 0;
        font-family: "ë§‘ì€ ê³ ë”•", sans-serif;
        background-color: #f3f4f6;
        color: #333;
      }

      header {
        background-color: #0078d7;
        color: white;
        padding: 20px 40px;
        font-size: 1.5em;
        font-weight: bold;
        text-align: center;
      }

      main {
        display: block;
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
      }

      section {
        background-color: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 40px;
      }

      textarea {
        width: 100%;
        height: 140px;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 12px;
        font-size: 1em;
        resize: none;
      }

      button {
        margin-top: 16px;
        padding: 12px 24px;
        background-color: #0078d7;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
      }

      button:hover {
        background-color: #005ea6;
      }

      .button-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 10px;
      }

      .button-left,
      .button-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #start-record {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        padding: 0;
      }

      #stop-record {
        width: 48px;
        height: 48px;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #0078d7;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.2em;
      }

      .result-box {
        padding: 20px;
        border-left: 6px solid #0078d7;
        border-radius: 8px;
        background-color: #fefefe;
        transition: border-color 0.3s;
      }

      .result-item {
        margin-bottom: 12px;
        font-size: 1.05em;
      }

      .result-label {
        font-weight: bold;
      }

      .encouragement {
        margin-top: 20px;
        background-color: #f0f8ff;
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid #00aaff;
        font-style: italic;
      }

      .score-guide {
        margin-top: 20px;
        font-size: 0.9em;
        color: #666;
        line-height: 1.4;
        background: #f7f7f7;
        padding: 10px 14px;
        border-radius: 8px;
      }

      footer {
        text-align: center;
        padding: 24px;
        font-size: 0.9em;
        color: #888;
        border-top: 1px solid #ddd;
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <header>ğŸ“ ê°ì • ë¶„ì„ í”Œë«í¼</header>

    <main>
      <section>
        <h2>ì˜¤ëŠ˜ì˜ ê°ì •ì¼ê¸° ì‘ì„±</h2>
        <form id="diary-form">
          <textarea
            id="diary"
            name="diary"
            placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì†”ì§í•˜ê²Œ ì ì–´ë³´ì„¸ìš”..."
          ></textarea>

          <div class="button-row">
            <div class="button-left">
              <button type="button" id="start-record" title="ë§í•˜ê¸° ì‹œì‘">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="white"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 14c1.66 0 3-1.34 3-3V5a3 3 0 10-6 0v6c0 1.66 1.34 3 3 3z"
                  />
                  <path
                    d="M17.3 11c0 3.07-2.4 5.6-5.3 5.98V19h3v2H9v-2h3v-2.02A6.01 6.01 0 016.7 11H5a7 7 0 0014 0h-1.7z"
                  />
                </svg>
              </button>

              <!-- ì´ ë¶€ë¶„ ìƒˆë¡œ êµ¬ì„± -->
              <div style="display: flex; align-items: center; gap: 6px">
                <button type="button" id="stop-record" style="display: none">
                  â›”
                </button>
                <span id="recording-status" style="color: #0078d7"></span>
              </div>
            </div>

            <div class="button-right">
              <button type="submit" id="analyze-button">ë¶„ì„í•˜ê¸°</button>
            </div>
          </div>
        </form>
      </section>

      <section>
        <h2>ë¶„ì„ ê²°ê³¼</h2>
        <div id="result">
          <p style="color: #888">
            ì¼ê¸°ë¥¼ ì‘ì„±í•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>
      </section>
    </main>

    <footer>Â© HYOIN AN | 2025 ê°ì •ë¶„ì„ í”Œë«í¼</footer>

    <script>
      const emotionIcons = {
        ìš°ìš¸: "ğŸ˜¢",
        ë¶ˆì•ˆ: "ğŸ˜Ÿ",
        ë¶„ë…¸: "ğŸ˜ ",
        ê¸°ì¨: "ğŸ˜„",
        ìŠ¬í””: "ğŸ˜­",
        ì•ˆì •: "ğŸ˜Š",
        í”¼ë¡œ: "ğŸ˜©",
        ë¬´ê¸°ë ¥: "ğŸ˜",
        ì ˆë§: "ğŸ˜”",
        í¬ë§: "ğŸŒˆ",
      };

      const resultDiv = document.getElementById("result");
      const form = document.getElementById("diary-form");
      
      const analyzeButton = document.querySelector('#analyze-button');

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // ë¡œë”© í‘œì‹œ
        resultDiv.innerHTML = `<p style="color: #0078D7;">ğŸ§  ê°ì • ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>`;
        analyzeButton.disabled = true;
        analyzeButton.textContent = "ë¶„ì„ ì¤‘...";

        const formData = new FormData(e.target);
        const res = await fetch("/analyze", {
          method: "POST",
          body: formData,
        });

        analyzeButton.disabled = false;
        analyzeButton.textContent = "ë¶„ì„í•˜ê¸°";

        const data = await res.json();

        if (data.error) {
          resultDiv.innerHTML = `<p style="color:red;">âš ï¸ ë¶„ì„ ì‹¤íŒ¨: ${
            data.raw || data.detail
          }</p>`;
          return;
        }

        const color =
          data.score >= 81
            ? "#d9534f"
            : data.score >= 61
            ? "#f0ad4e"
            : data.score >= 31
            ? "#f9e79f"
            : "#5cb85c";
        const icon = emotionIcons[data.emotion] || "ğŸ§ ";

        resultDiv.innerHTML = `
      <div class="result-box" style="border-color: ${color};">
        <div class="result-item"><span class="result-label">ê°ì •:</span> ${icon} ${
          data.emotion
        }</div>
        <div class="result-item"><span class="result-label">ì ìˆ˜:</span> ${
          data.score
        }ì </div>
        <div class="result-item"><span class="result-label">ì´ìœ :</span> ${
          data.reason
        }</div>
        <div class="result-item"><span class="result-label">ì‘ì›ì˜ í•œë§ˆë””:</span> ${
          data.message
        }</div>
        <div class="encouragement">ğŸ’¬ ì˜¤ëŠ˜ì˜ ìœ„ë¡œ: â€œ${
          data.comfort || "ì˜¤ëŠ˜ë„ ì˜ ë²„í…¼ì–´ìš”. ìˆ˜ê³ í–ˆì–´ìš” :)"
        }â€</div>
        <div class="score-guide">
          <strong>ì ìˆ˜ í•´ì„ ì•ˆë‚´:</strong><br>
          âœ… 0~30: ê°ì • ì•ˆì • ìƒíƒœ<br>
          âš ï¸ 31~60: ê°€ë²¼ìš´ ê°ì • ë³€í™”<br>
          â— 61~80: ë¶€ì • ê°ì • ê°•í•¨<br>
          ğŸ”¥ 81~100: ê°ì •ì ìœ¼ë¡œ ë§¤ìš° í˜ë“  ìƒíƒœ
        </div>
      </div>
    `;
      });

      const startBtn = document.getElementById("start-record");
      const stopBtn = document.getElementById("stop-record");
      const statusText = document.getElementById("recording-status");
      const diary = document.getElementById("diary");
      let recognition = null;

      function setupRecognition() {
        const recog = new webkitSpeechRecognition();
        recog.lang = "ko-KR";
        recog.interimResults = false;
        recog.maxAlternatives = 1;

        recog.onstart = () => {
          statusText.textContent = "ğŸ™ï¸ ë“£ê³  ìˆì–´ìš”...";
          startBtn.style.display = "none";
          stopBtn.style.display = "inline-block";
        };

        recog.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          diary.value += (diary.value ? " " : "") + transcript;
        };

        recog.onerror = (event) => {
          statusText.textContent = "âš ï¸ ì˜¤ë¥˜: " + event.error;
        };

        recog.onend = () => {
          statusText.textContent = "";
          startBtn.style.display = "inline-block";
          stopBtn.style.display = "none";
        };

        return recog;
      }

      startBtn.addEventListener("click", () => {
        recognition = setupRecognition();
        recognition.start();
      });

      stopBtn.addEventListener("click", () => {
        if (recognition) {
          recognition.stop();
          recognition = null;
        }
      });
    </script>
  </body>
</html>
